## TripHub 使用注意事项与常见问题

> 本文只保留与当前代码一致的环境与排错提示，所有早期的「基于 Redis + MQ 的额外高并发 Demo」内容已经移除。

### 1. 运行环境与必备组件

- **JDK 版本**
  - 项目基于 JDK 17 开发，建议使用 17 及以上版本运行。
- **数据库**
  - 依赖 MySQL 8.x，默认数据库名为 `triphub`。
  - 本地可直接使用仓库根目录的 `docker-compose.yml` 启动 MySQL 容器：
    - 容器名：`triphub-mysql`
    - 端口映射：`3306:3306`
    - 会自动执行 `db/init_triphub.sql` 完成库表初始化。
- **Redis**
  - 用于行程缓存、热门榜单、限流与幂等控制。
  - 本地同样可通过 `docker-compose.yml` 启动：
    - 容器名：`triphub-redis`
    - 端口映射：`6379:6379`

### 2. 配置文件与运行配置

- **Spring Profile**
  - 默认使用 `application.yml`，建议本地开发启用 `dev` 配置：
    - 启动参数中添加 `--spring.profiles.active=dev`。
  - 容器环境下，`docker-compose.yml` 中已经将 `SPRING_PROFILES_ACTIVE` 设置为 `prod`，并通过环境变量注入 DB / Redis / AI 配置。

- **数据库连接**
  - `application-dev.yml` 中配置了默认的本地数据库连接，例如：
    - `jdbc:mysql://localhost:3306/triphub?...`
  - 若本地端口或密码不同，请同步修改对应配置或环境变量。

- **Redis 连接**
  - 默认连接 `localhost:6379`，容器环境下通过环境变量注入 Redis 主机名和端口。
  - 如出现 `Cannot get Jedis connection` / `RedisConnectionException` 等错误，优先检查：
    - Redis 服务是否启动；
    - 地址和端口是否与配置一致。

- **AI 调用配置**
  - AI 行程规划与助手功能通过 `triphub.ai.*` 配置项与环境变量控制：
    - `TRIPHUB_AI_BASE_URL`
    - `TRIPHUB_AI_MODEL`
    - `TRIPHUB_AI_API_KEY`
  - 若未配置有效的 Key，接口会自动降级为本地拼接说明文案，不会影响整体接口可用性。

### 3. 常见启动问题与排查思路

#### 3.1 数据库不可达

- **现象**
  - 应用启动时抛出类似：
    - `Communications link failure`
    - `Unknown database 'triphub'`
- **排查步骤**
  - 确认 MySQL 服务已启动，端口开放；
  - 使用客户端手动连接验证账号密码；
  - 检查是否已经执行或挂载 `db/init_triphub.sql`；
  - 如是 Docker 环境，注意容器网络与主机端口映射是否正确。

#### 3.2 Redis 未启动或端口不一致

- **现象**
  - 启动日志中出现：
    - `Cannot get Jedis connection`
    - `Unable to connect to Redis server: ...`
- **排查步骤**
  - 确保 Redis 服务已启动，默认监听 `6379` 端口；
  - 本地自建 Redis 时，检查 `spring.redis.host/port` 是否与实际一致；
  - 容器环境下确认 `TRIPHUB_REDIS_HOST` / `TRIPHUB_REDIS_PORT` 是否正确。

#### 3.3 Redisson / Redis 未启动导致应用启动失败

- **现象**
  - 创建 `RedissonClient` Bean 时抛出异常，例如：
    - `Error creating bean with name 'redissonClient'`
    - `RedisConnectionException: Unable to connect to Redis server: localhost/127.0.0.1:6379`
- **原因**
  - `RedissonConfig` 在应用启动阶段就会尝试连接 Redis；
  - 若 Redis 未启动或地址错误，会导致 Bean 创建失败，从而影响应用启动。
- **建议处理方式**
  - 本地开发时，优先确保 Redis 已启动；
  - 或在 `RedissonConfig` 上增加条件开关，例如：
    - `@ConditionalOnProperty(prefix = "triphub.redisson", name = "enabled", havingValue = "true")`
  - 并在配置文件中显式控制：
    - `triphub.redisson.enabled=false` 表示暂时关闭 Redisson 相关功能，仅用于调试其他模块。

### 4. 缓存与热门榜单相关注意事项

#### 4.1 行程缓存逻辑过期与回源

- 行程详情缓存使用逻辑过期 + 互斥重建策略：
  - Key 为 `cache:trip:{id}`；
  - 逻辑过期后，优先返回旧数据，并尝试由单个线程异步重建缓存。
- 若 Redis 被清空或缓存过期未及时重建：
  - 首次访问会回源 DB 并重新写入缓存；
  - 只要 DB 中有真实数据，接口不应该直接返回「行程不存在」。

#### 4.2 热门榜单 ZSet 自愈

- 热门行程与热门目的地基于 ZSet 实现：
  - 行程热门榜：`hot:trip`
  - 目的地热门榜：`hot:dest`
- 如果 Redis 数据被运维清空：
  - 随着用户再次访问行程详情，ZSet 会自然被重新写入；
  - 也可以通过后台定时任务（如 `ConsistencyReconciliationTask`）按 DB 的 `view_count` 重建榜单，体现 Redis 作为「可丢失缓存层」的设计原则。

### 5. AI 相关异常与降级

- **未配置 AI Key / base-url 错误**
  - `POST /user/ai/trip-plan` 与 `POST /user/ai/assistant` 在外部 LLM 不可用时，会回退为本地拼接说明文案；
  - 接口仍返回 `code = 0`，只是在解释字段中不再体现大模型生成的个性化内容。

- **画像 JSON 异常**
  - 如果 `user_profile.profile_json` 被手工改坏（非法 JSON）：
    - 解析失败时会自动退化为「空画像」；
    - AI 接口仍然可用，只是解释文案不再使用画像细节。

### 6. 总结

- 当前版本的 TripHub 只依赖 **MySQL + Redis + 可选的外部 LLM 服务**，不再包含任何额外的基于 MQ 的高并发 Demo 功能或依赖；
- 如在阅读文档或代码注释时仍看到旧版本的相关说明，可以直接忽略，或以本文件与代码实现为准。  


