## 核心 API 异常场景测试表

> 覆盖登录、行程详情、热门榜单、秒杀等核心接口的异常用例，方便 QA 设计回归用例。

### 1. 登录与鉴权相关

#### 1.1 `/user/auth/login`

| 接口 | 场景                   | 预期行为                                         |
|------|------------------------|--------------------------------------------------|
| 登录 | 正常手机号 + 正确验证码 | `code = 0`，返回非空 token                      |
| 登录 | 正常手机号 + 错误验证码 | `code = 1`，提示「验证码错误」或类似文案         |
| 登录 | 手机号为空 / 非法格式   | `code = 1`，参数校验失败，提示明确错误字段       |

#### 1.2 受保护接口（如 `/user/profile/me`）

| 接口             | 场景                   | 预期行为                                  |
|------------------|------------------------|-------------------------------------------|
| 当前用户信息     | 未携带 token           | `code = 1`，提示「未登录或 token 无效」    |
| 当前用户信息     | 携带过期 / 伪造 token  | `code = 1`，提示「未登录或 token 无效」    |
| 当前用户信息     | 携带正常 token         | `code = 0`，返回当前用户信息              |

### 2. 行程详情与权限相关

#### 2.1 `/user/trip/{id}`

| 接口       | 场景                              | 预期行为                                                     |
|------------|-----------------------------------|--------------------------------------------------------------|
| 行程详情   | `id` 不存在                       | `code = 1`，提示「行程不存在」                               |
| 行程详情   | `id` 存在，但属于其他用户且私有   | 返回 `code = 1` 或 403 风格错误，不能泄露敏感字段           |
| 行程详情   | `id` 存在，公开行程               | `code = 0`，正常返回                                         |
| 行程详情   | Redis 已被清空                    | 首次访问回源 DB，自动重建缓存，`code = 0`                    |

#### 2.2 `/user/trip/day/detail`

| 接口               | 场景                           | 预期行为                                                     |
|--------------------|--------------------------------|--------------------------------------------------------------|
| 按天详情           | 行程 ID 不存在                | `code = 1`，提示「行程不存在」                               |
| 按天详情           | `dayIndex` 越界 / 非法        | `code = 1`，参数校验失败                                     |
| 按天详情           | 无任意条目                   | `code = 0`，`items` 数组为空，`note` 为 `null`               |

### 3. 热门榜单接口

#### `/user/discover/hot-trips` 与 `/user/discover/hot-destinations`

| 接口                 | 场景                           | 预期行为                                                  |
|----------------------|--------------------------------|-----------------------------------------------------------|
| 热门行程             | 无数据                         | `code = 0`，返回空数组 `[]`                               |
| 热门行程             | Redis ZSet 被清空             | 重新有访问产生后逐步重建榜单                             |
| 热门目的地           | 请求 `limit` 为 0 或负数       | 参数校验失败或自动修正为默认 TopN                        |

### 4. 秒杀相关接口

#### 4.1 `POST /user/seckill/{activityId}`

| 场景                           | 预期行为                                                                 |
|--------------------------------|--------------------------------------------------------------------------|
| 活动存在，库存充足，首次下单   | `code = 0`，`data` 为非空订单 ID                                         |
| 活动存在，库存为 0             | `code = 1`，`msg = "Seckill stock is not enough"`                        |
| 活动不存在                     | `code = 1`，提示「活动不存在」或等价文案                                |
| 同一用户重复下单               | `code = 1`，`msg = "User has already placed an order for this activity"` |
| Redis 中 `seckill:stock` 不存在 | 预期按「库存不足」分支处理，并记录 ERROR 级日志用于排查                   |
| MQ 未启动 / 无法连接          | 不影响 Lua 预检结果，但日志中应有错误提示，订单可能滞留于 Redis 状态     |

### 5. 系统级异常与降级

| 场景                          | 预期行为                                                         |
|-------------------------------|------------------------------------------------------------------|
| Redis 故障（不可连通）       | 读操作优先回源 DB，日志打 ERROR；尽可能不对外直接暴露 500       |
| MySQL 故障                    | 相关接口返回统一系统异常文案（例如「系统异常，请稍后再试」）    |
| RabbitMQ 连接异常             | 秒杀相关功能不可用，日志中持续输出 `AmqpConnectException`，其他接口不受影响 |

> 建议：QA 在设计测试用例时，可以以本表为基础，补充更细粒度的边界条件（如参数极值、并发下的竞态场景等），并将期望返回的 `code` / `msg` 细化到具体字符串，方便自动化断言。


